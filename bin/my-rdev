#!/bin/bash

set -e

# =============================================================================
# Shared Utilities
# =============================================================================

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_msg() {
    local type=$1 msg=$2
    local color
    case "$type" in
        INFO) color="$BLUE" ;;
        SUCCESS) color="$GREEN" ;;
        ERROR) color="$RED" ;;
        WARNING) color="$YELLOW" ;;
    esac
    echo -e "${color}[$type]${NC} $msg"
}

# Check if required tools are installed
check_dependencies() {
    command -v rdev &> /dev/null || { print_msg ERROR "rdev is not installed or not in PATH"; exit 1; }
    command -v mutagen &> /dev/null || {
        print_msg ERROR "mutagen is not installed. Please install it first:"
        echo "  brew install mutagen-io/mutagen/mutagen"
        exit 1
    }
}

# Main usage function
usage() {
    cat << EOF
Usage: my-rdev <subcommand> [options]

Manage rdev environments with mutagen sync.

Subcommands:
    create    Create an rdev and set up mutagen sync
    delete    Delete an rdev and clean up local resources
    help      Show this help message

Run 'my-rdev <subcommand> --help' for more information on a subcommand.

Examples:
    my-rdev create campaign-manager-web --ignore node_modules
    my-rdev delete campaign-manager-web/nutty-otter

EOF
    exit 1
}

# =============================================================================
# Create Subcommand
# =============================================================================

usage_create() {
    cat << EOF
Usage: my-rdev create <codebase> [--ignore pattern1] [--ignore pattern2] ...

Create an rdev and set up mutagen sync.

Arguments:
    codebase            The name of the codebase to create rdev for (e.g., campaign-manager-web)
    --ignore PATTERN    Files/folders to ignore in mutagen sync (can be specified multiple times)

Examples:
    # Frontend codebase
    my-rdev create campaign-manager-web --ignore node_modules --ignore .git

    # Java backend codebase
    my-rdev create some-java-service --ignore target --ignore .gradle --ignore build

    # Minimal create
    my-rdev create my-project

EOF
    exit 1
}

parse_create_args() {
    if [ $# -eq 0 ] || [ "$1" == "--help" ] || [ "$1" == "-h" ]; then
        usage_create
    fi

    CODEBASE="$1"
    shift

    IGNORE_PATTERNS=()
    while [ $# -gt 0 ]; do
        case "$1" in
            --ignore)
                [ -z "$2" ] && { print_msg ERROR "--ignore requires a pattern argument"; exit 1; }
                IGNORE_PATTERNS+=("$2")
                shift 2
                ;;
            *)
                print_msg ERROR "Unknown argument: $1"
                usage_create
                ;;
        esac
    done

    # Add default ignore patterns for specific codebases
    if [ "$CODEBASE" == "campaign-manager-web" ]; then
        # Check if node_modules is not already in ignore patterns
        if [[ ! " ${IGNORE_PATTERNS[@]} " =~ " node_modules " ]]; then
            IGNORE_PATTERNS+=("node_modules")
        fi
    fi
}

create_rdev() {
    print_msg INFO "Creating rdev for $CODEBASE..."

    # Capture rdev create output
    RDEV_OUTPUT=$(rdev create "$CODEBASE" 2>&1) || {
        print_msg ERROR "Failed to create rdev"
        echo "$RDEV_OUTPUT"
        exit 1
    }

    echo "$RDEV_OUTPUT"

    # Extract the rdev name (format: codebase/generated-name)
    RDEV_FULL_NAME=$(echo "$RDEV_OUTPUT" | grep -oE "${CODEBASE}/[a-z-]+" | head -1)
    [ -z "$RDEV_FULL_NAME" ] && {
        print_msg ERROR "Could not extract rdev name from output"
        print_msg WARNING "Please manually check the rdev name and set up mutagen sync"
        exit 1
    }

    # Extract just the generated suffix (e.g., "quirky-daffodil")
    RDEV_SUFFIX=$(echo "$RDEV_FULL_NAME" | cut -d'/' -f2)

    print_msg SUCCESS "Created rdev: $RDEV_FULL_NAME"
}

create_local_directory() {
    LOCAL_DIR="$HOME/code/rdev/${CODEBASE}-${RDEV_SUFFIX}"

    if [ -d "$LOCAL_DIR" ]; then
        print_msg WARNING "Directory already exists: $LOCAL_DIR"
        read -p "Do you want to continue and sync to this directory? (y/n) " -n 1 -r
        echo
        [[ ! $REPLY =~ ^[Yy]$ ]] && { print_msg ERROR "Aborted by user"; exit 1; }
    else
        mkdir -p "$LOCAL_DIR"
    fi
}

start_mutagen_sync() {
    SESSION_NAME="${CODEBASE}-${RDEV_SUFFIX}"
    REMOTE_PATH="${CODEBASE}_${RDEV_SUFFIX}:/home/coder/${CODEBASE}"

    local ignore_flags=$(printf -- '--ignore "%s" ' "${IGNORE_PATTERNS[@]}")

    mutagen sync create "$LOCAL_DIR" "$REMOTE_PATH" --name "$SESSION_NAME" $ignore_flags || {
        print_msg ERROR "Failed to start mutagen sync"
        exit 1
    }
    print_msg SUCCESS "Sync session created: $SESSION_NAME"
}

monitor_sync() {
    print_msg INFO "Syncing files (this may take a while)..."
    print_msg INFO "Press Ctrl+C to stop monitoring (sync will continue in background)"
    echo ""

    # Use mutagen sync monitor which streams output until sync is complete
    mutagen sync monitor "$SESSION_NAME" || true

    print_msg SUCCESS "Sync complete!"
}

print_create_completion() {
    cat <<EOF

$(print_msg SUCCESS "Setup complete!")

Rdev: $RDEV_FULL_NAME
Local: $LOCAL_DIR

Next steps:
  cd $LOCAL_DIR

Commands:
  rdev ssh $RDEV_FULL_NAME
  mutagen sync monitor $SESSION_NAME

EOF
}

create_command() {
    check_dependencies
    parse_create_args "$@"
    create_rdev
    create_local_directory
    start_mutagen_sync
    monitor_sync
    print_create_completion
}

# =============================================================================
# Delete Subcommand
# =============================================================================

usage_delete() {
    cat << EOF
Usage: my-rdev delete <rdev-name>

Delete an rdev and clean up local resources.

Arguments:
    rdev-name    The full rdev name (e.g., campaign-manager-web/nutty-otter)

Examples:
    my-rdev delete campaign-manager-web/nutty-otter
    my-rdev delete my-service/happy-tree

This will:
  1. Delete the remote rdev
  2. Remove the local directory
  3. Terminate the mutagen sync session

EOF
    exit 1
}

parse_delete_args() {
    if [ $# -eq 0 ] || [ "$1" == "--help" ] || [ "$1" == "-h" ]; then
        usage_delete
    fi

    RDEV_FULL_NAME="$1"

    # Validate format: codebase/suffix
    if [[ ! "$RDEV_FULL_NAME" =~ ^[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+$ ]]; then
        print_msg ERROR "Invalid rdev name format. Expected: codebase/suffix"
        exit 1
    fi

    # Extract codebase and suffix
    CODEBASE=$(echo "$RDEV_FULL_NAME" | cut -d'/' -f1)
    RDEV_SUFFIX=$(echo "$RDEV_FULL_NAME" | cut -d'/' -f2)

    # Derive names
    LOCAL_DIR="$HOME/code/rdev/${CODEBASE}-${RDEV_SUFFIX}"
    SESSION_NAME="${CODEBASE}-${RDEV_SUFFIX}"
}

delete_rdev() {
    print_msg INFO "Deleting rdev: $RDEV_FULL_NAME..."

    rdev delete -f "$RDEV_FULL_NAME" 2>&1 || {
        print_msg ERROR "Failed to delete rdev"
        exit 1
    }

    print_msg SUCCESS "Rdev deleted"
}

terminate_mutagen_session() {
    print_msg INFO "Terminating mutagen session: $SESSION_NAME..."

    # Check if session exists
    if mutagen sync list "$SESSION_NAME" &> /dev/null; then
        mutagen sync terminate "$SESSION_NAME" || {
            print_msg WARNING "Failed to terminate mutagen session (may not exist)"
        }
        print_msg SUCCESS "Mutagen session terminated"
    else
        print_msg INFO "Mutagen session not found (may already be deleted)"
    fi
}

delete_local_directory() {
    if [ -d "$LOCAL_DIR" ]; then
        print_msg INFO "Deleting local directory: $LOCAL_DIR..."

        rm -rf "$LOCAL_DIR" || {
            print_msg ERROR "Failed to delete local directory"
            exit 1
        }

        print_msg SUCCESS "Local directory deleted"
    else
        print_msg INFO "Local directory not found (may already be deleted)"
    fi
}

print_delete_summary() {
    cat <<EOF

$(print_msg SUCCESS "Cleanup complete!")

Removed:
  - Rdev: $RDEV_FULL_NAME
  - Local directory: $LOCAL_DIR
  - Mutagen session: $SESSION_NAME

EOF
}

delete_command() {
    check_dependencies
    parse_delete_args "$@"

    # Confirm deletion
    echo ""
    print_msg WARNING "This will delete:"
    echo "  - Rdev: $RDEV_FULL_NAME"
    echo "  - Local directory: $LOCAL_DIR"
    echo "  - Mutagen session: $SESSION_NAME"
    echo ""
    read -p "Are you sure you want to continue? (y/n) " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_msg INFO "Cancelled"
        exit 0
    fi
    echo ""

    delete_rdev
    terminate_mutagen_session
    delete_local_directory
    print_delete_summary
}

# =============================================================================
# Main Entry Point
# =============================================================================

main() {
    # No arguments or help flag
    if [ $# -eq 0 ] || [ "$1" == "--help" ] || [ "$1" == "-h" ] || [ "$1" == "help" ]; then
        usage
    fi

    # Route to subcommand
    SUBCOMMAND="$1"
    shift

    case "$SUBCOMMAND" in
        create)
            create_command "$@"
            ;;
        delete)
            delete_command "$@"
            ;;
        *)
            print_msg ERROR "Unknown subcommand: $SUBCOMMAND"
            echo ""
            usage
            ;;
    esac
}

main "$@"
