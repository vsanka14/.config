#!/usr/bin/env bash
# ptop - interactive process manager using fzf
# Usage: ptop [--sort cpu|mem|pid] [--user]

SORT="mem"
USER_ONLY=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --sort) SORT="$2"; shift 2 ;;
    --user) USER_ONLY=true; shift ;;
    -h|--help)
      echo "Usage: ptop [--sort cpu|mem|pid] [--user]"
      echo "  --sort   Sort by cpu (default), mem, or pid"
      echo "  --user   Show only your processes"
      echo ""
      echo "Controls:"
      echo "  enter    Kill selected process (SIGTERM)"
      echo "  ctrl-k   Kill selected process (SIGKILL)"
      echo "  ctrl-r   Refresh process list"
      echo "  ctrl-p   Toggle preview"
      echo "  tab      Select multiple processes"
      echo "  esc/q    Quit"
      exit 0
      ;;
    *) echo "Unknown option: $1"; exit 1 ;;
  esac
done

list_procs() {
  local user_flag=""
  if $USER_ONLY; then
    user_flag="-u $USER"
  else
    user_flag="-e"
  fi

  # Don't trust macOS ps -r/-m flags — they're unreliable.
  # Sort ourselves: pid=col1, cpu=col2, mem=col3, rss=col4
  local sort_col
  case "$SORT" in
    cpu) sort_col=2 ;;
    mem) sort_col=4 ;;
    pid) sort_col=1 ;;
    *)   echo "Invalid sort key: $SORT (use cpu, mem, pid)"; exit 1 ;;
  esac

  ps $user_flag -o pid,pcpu,pmem,rss,etime,command 2>/dev/null \
    | tail -n +2 \
    | sort -k${sort_col} -rn
}

format_procs() {
  # TokyoNight colors
  local blue="\033[38;2;122;162;247m"   # #7aa2f7
  local cyan="\033[38;2;125;207;255m"   # #7dcfff
  local green="\033[38;2;158;206;106m"  # #9ece6a
  local yellow="\033[38;2;224;175;104m" # #e0af68
  local red="\033[38;2;247;118;142m"    # #f7768e
  local magenta="\033[38;2;187;154;247m" # #bb9af7
  local dim="\033[38;2;86;95;137m"      # #565f89
  local reset="\033[0m"

  printf "${blue}%-8s${reset} ${cyan}%-7s${reset} ${magenta}%-7s${reset} ${green}%-10s${reset} ${dim}%-12s${reset} %s\n" \
    "PID" "CPU%" "MEM%" "RSS(MB)" "ELAPSED" "COMMAND"
  list_procs | while read -r pid cpu mem rss elapsed cmd; do
    rss_mb=$(awk "BEGIN {printf \"%.1f\", $rss/1024}")
    # Color CPU and MEM values by intensity
    local cpu_color="$dim"
    local mem_color="$dim"
    awk "BEGIN {exit ($cpu >= 50)}" || cpu_color="$red"
    awk "BEGIN {exit ($cpu >= 10 && $cpu < 50)}" || cpu_color="$yellow"
    awk "BEGIN {exit ($cpu > 0 && $cpu < 10)}" || cpu_color="$green"
    awk "BEGIN {exit ($rss >= 2097152)}" || mem_color="$red"       # >= 2GB
    awk "BEGIN {exit ($rss >= 524288 && $rss < 2097152)}" || mem_color="$yellow"  # >= 512MB
    awk "BEGIN {exit ($rss > 0 && $rss < 524288)}" || mem_color="$green"
    printf "${blue}%-8s${reset} ${cpu_color}%-7s${reset} ${mem_color}%-7s${reset} ${mem_color}%-10s${reset} ${dim}%-12s${reset} %s\n" \
      "$pid" "$cpu" "$mem" "$rss_mb" "$elapsed" "$cmd"
  done
}

RELOAD_CMD="bash -c '$(declare -f list_procs format_procs); SORT=\"$SORT\"; USER_ONLY=$USER_ONLY; format_procs'"

export -f list_procs format_procs 2>/dev/null
export SORT USER_ONLY

PREVIEW_CMD='pid=$(echo {} | awk "{print \$1}"); [[ "$pid" =~ ^[0-9]+$ ]] && ps -p "$pid" -o pid,ppid,user,stat,%cpu,%mem,rss,vsz,etime,command 2>/dev/null && echo "---" && lsof -p "$pid" 2>/dev/null | head -20 || echo "Process not found"'

# fzf overrides (base theme from FZF_DEFAULT_OPTS in zshrc)
TN_FZF_COLORS="bg:-1,gutter:-1,preview-bg:-1"
TN_FZF_COLORS+=",hl:#ff9e64,hl+:#ff9e64"  # Orange highlights for process names

result=$(format_procs | fzf \
  --multi \
  --header-lines=1 \
  --header="enter:TERM  ctrl-k:KILL  ctrl-r:refresh  tab:multi-select  ctrl-c:quit" \
  --preview="$PREVIEW_CMD" \
  --preview-window=down:40%:wrap:border-top \
  --bind="ctrl-r:reload($RELOAD_CMD)" \
  --bind="ctrl-p:toggle-preview" \
  --bind="ctrl-k:execute(echo {} | awk '{print \$1}' | xargs -I{} kill -9 {})+reload($RELOAD_CMD)" \
  --bind="j:down,k:up,g:first,G:last" \
  --bind="ctrl-d:half-page-down,ctrl-u:half-page-up" \
  --bind="/:enable-search" \
  --bind="esc:ignore" \
  --disabled \
  --expect=enter \
  --ansi \
  --no-sort \
  --layout=reverse \
  --border=rounded \
  --border-label=" ptop " \
  --border-label-pos=3 \
  --prompt="  " \
  --pointer="▌" \
  --marker="●" \
  --color="$TN_FZF_COLORS" \
)

# Handle enter key (SIGTERM)
key=$(echo "$result" | head -1)
selection=$(echo "$result" | tail -n +2)

if [[ "$key" == "enter" && -n "$selection" ]]; then
  echo "$selection" | while read -r line; do
    pid=$(echo "$line" | awk '{print $1}')
    if [[ "$pid" =~ ^[0-9]+$ ]]; then
      cmd=$(echo "$line" | awk '{for(i=6;i<=NF;i++) printf "%s ", $i; print ""}')
      echo "Sending SIGTERM to PID $pid ($cmd)"
      kill "$pid" 2>/dev/null && echo "  -> Sent" || echo "  -> Failed (try with sudo)"
    fi
  done
fi
