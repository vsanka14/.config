#!/bin/bash

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_msg() {
    local type=$1 msg=$2
    local color
    case "$type" in
        INFO) color="$BLUE" ;;
        SUCCESS) color="$GREEN" ;;
        ERROR) color="$RED" ;;
        WARNING) color="$YELLOW" ;;
    esac
    echo -e "${color}[$type]${NC} $msg"
}

# Usage function
usage() {
    cat << EOF
Usage: rdev-setup <codebase> [--ignore pattern1] [--ignore pattern2] ...

Automates the rdev creation and mutagen sync setup process.

Arguments:
    codebase            The name of the codebase to create rdev for (e.g., campaign-manager-web)
    --ignore PATTERN    Files/folders to ignore in mutagen sync (can be specified multiple times)

Examples:
    # Frontend codebase
    rdev-setup campaign-manager-web --ignore node_modules --ignore .git

    # Java backend codebase
    rdev-setup some-java-service --ignore target --ignore .gradle --ignore build

    # Minimal setup
    rdev-setup my-project

EOF
    exit 1
}

# Check if mutagen is installed
check_dependencies() {
    command -v mutagen &> /dev/null || {
        print_msg ERROR "mutagen is not installed. Please install it first:"
        echo "  brew install mutagen-io/mutagen/mutagen"
        exit 1
    }
    command -v rdev &> /dev/null || { print_msg ERROR "rdev is not installed or not in PATH"; exit 1; }
}

# Parse command line arguments
parse_args() {
    if [ $# -eq 0 ] || [ "$1" == "--help" ] || [ "$1" == "-h" ]; then
        usage
    fi

    CODEBASE="$1"
    shift

    IGNORE_PATTERNS=()
    while [ $# -gt 0 ]; do
        case "$1" in
            --ignore)
                [ -z "$2" ] && { print_msg ERROR "--ignore requires a pattern argument"; exit 1; }
                IGNORE_PATTERNS+=("$2")
                shift 2
                ;;
            *)
                print_msg ERROR "Unknown argument: $1"
                usage
                ;;
        esac
    done

    # Add default ignore patterns for specific codebases
    if [ "$CODEBASE" == "campaign-manager-web" ]; then
        # Check if node_modules is not already in ignore patterns
        if [[ ! " ${IGNORE_PATTERNS[@]} " =~ " node_modules " ]]; then
            IGNORE_PATTERNS+=("node_modules")
        fi
    fi
}

# Create rdev and extract the generated name
create_rdev() {
    print_msg INFO "Creating rdev for $CODEBASE..."

    # Capture rdev create output
    RDEV_OUTPUT=$(rdev create "$CODEBASE" 2>&1) || {
        print_msg ERROR "Failed to create rdev"
        echo "$RDEV_OUTPUT"
        exit 1
    }

    echo "$RDEV_OUTPUT"

    # Extract the rdev name (format: codebase/generated-name)
    RDEV_FULL_NAME=$(echo "$RDEV_OUTPUT" | grep -oE "${CODEBASE}/[a-z-]+" | head -1)
    [ -z "$RDEV_FULL_NAME" ] && {
        print_msg ERROR "Could not extract rdev name from output"
        print_msg WARNING "Please manually check the rdev name and set up mutagen sync"
        exit 1
    }

    # Extract just the generated suffix (e.g., "quirky-daffodil")
    RDEV_SUFFIX=$(echo "$RDEV_FULL_NAME" | cut -d'/' -f2)

    print_msg SUCCESS "Created rdev: $RDEV_FULL_NAME"
}

# Create local directory
create_local_directory() {
    LOCAL_DIR="$HOME/code/rdev/${CODEBASE}-${RDEV_SUFFIX}"
    print_msg INFO "Creating local directory: $LOCAL_DIR"

    if [ -d "$LOCAL_DIR" ]; then
        print_msg WARNING "Directory already exists: $LOCAL_DIR"
        read -p "Do you want to continue and sync to this directory? (y/n) " -n 1 -r
        echo
        [[ ! $REPLY =~ ^[Yy]$ ]] && { print_msg ERROR "Aborted by user"; exit 1; }
    else
        mkdir -p "$LOCAL_DIR" && print_msg SUCCESS "Created directory: $LOCAL_DIR"
    fi
}

# Start mutagen sync
start_mutagen_sync() {
    SESSION_NAME="${CODEBASE}-${RDEV_SUFFIX}"
    REMOTE_PATH="${CODEBASE}_${RDEV_SUFFIX}:/home/coder/${CODEBASE}"

    print_msg INFO "Starting mutagen sync session: $SESSION_NAME"
    print_msg INFO "Local:  $LOCAL_DIR"
    print_msg INFO "Remote: $REMOTE_PATH"

    local ignore_flags=$(printf -- '--ignore "%s" ' "${IGNORE_PATTERNS[@]}")
    [[ -n "$ignore_flags" ]] && print_msg INFO "Ignoring: ${IGNORE_PATTERNS[*]}"

    mutagen sync create "$LOCAL_DIR" "$REMOTE_PATH" --name "$SESSION_NAME" $ignore_flags || {
        print_msg ERROR "Failed to start mutagen sync"
        exit 1
    }
    print_msg SUCCESS "Mutagen sync session started"
}

# Monitor mutagen sync until it's ready
monitor_sync() {
    local statuses=("Watching for changes:done" "Staging files" "Scanning files" "Reconciling changes" "Transitioning")

    print_msg INFO "Waiting for sync to complete (this may take a while)..."
    print_msg INFO "Monitoring session: $SESSION_NAME"
    sleep 2

    while true; do
        local status=$(mutagen sync list "$SESSION_NAME" 2>&1)
        for check in "${statuses[@]}"; do
            [[ "$status" =~ ${check%%:*} ]] && {
                [[ "$check" == *":done" ]] && { print_msg SUCCESS "Sync complete! Status: Watching for changes"; return; }
                print_msg INFO "Status: ${check%%:*}..."
                break
            }
        done
        sleep 3
    done
}

# Print final instructions
print_completion() {
    cat <<EOF

$(print_msg SUCCESS "==========================================")
$(print_msg SUCCESS "  rdev-setup completed successfully!")
$(print_msg SUCCESS "==========================================")

$(print_msg INFO "Your rdev is ready at: $RDEV_FULL_NAME")
$(print_msg INFO "Local directory: $LOCAL_DIR")
$(print_msg INFO "Mutagen session: $SESSION_NAME")

$(print_msg INFO "Next steps:")
  1. cd $LOCAL_DIR
  2. Open your editor (e.g., nvim)
  3. Start coding - changes will sync automatically!

$(print_msg INFO "To SSH into your rdev:")
  rdev ssh $RDEV_FULL_NAME

$(print_msg INFO "To monitor sync status:")
  mutagen sync monitor $SESSION_NAME

EOF
}

# Main execution
main() {
    check_dependencies
    parse_args "$@"
    create_rdev
    create_local_directory
    start_mutagen_sync
    monitor_sync
    print_completion
}

main "$@"
