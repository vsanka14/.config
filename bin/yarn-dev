#!/bin/bash

set -e

# =============================================================================
# yarn-dev: Install only devDependencies from package.json
# =============================================================================

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_msg() {
    local type=$1 msg=$2
    local color
    case "$type" in
        INFO) color="$BLUE" ;;
        SUCCESS) color="$GREEN" ;;
        ERROR) color="$RED" ;;
        WARNING) color="$YELLOW" ;;
    esac
    echo -e "${color}[$type]${NC} $msg"
}

usage() {
    cat << EOF
Usage: yarn-dev [directory] [yarn-options]

Install only devDependencies from a project's package.json.

Arguments:
    directory       Project directory containing package.json (default: current directory)
    yarn-options    Additional options to pass to yarn (e.g., --frozen-lockfile)

Examples:
    yarn-dev                          # Install devDeps in current directory
    yarn-dev ./my-project             # Install devDeps in specified directory
    yarn-dev . --frozen-lockfile      # Install with frozen lockfile

EOF
    exit 1
}

check_dependencies() {
    command -v yarn &> /dev/null || { print_msg ERROR "yarn is not installed or not in PATH"; exit 1; }
    command -v jq &> /dev/null || { print_msg ERROR "jq is not installed. Please install it: brew install jq"; exit 1; }
}

main() {
    if [ "$1" == "--help" ] || [ "$1" == "-h" ]; then
        usage
    fi

    check_dependencies

    # Determine project directory
    local project_dir="."
    local yarn_args=()

    if [ $# -gt 0 ]; then
        # Check if first arg is a directory
        if [ -d "$1" ]; then
            project_dir="$1"
            shift
        fi
        # Remaining args are yarn options
        yarn_args=("$@")
    fi

    # Resolve to absolute path
    project_dir=$(cd "$project_dir" && pwd)
    local package_json="$project_dir/package.json"

    # Verify package.json exists
    if [ ! -f "$package_json" ]; then
        print_msg ERROR "No package.json found in $project_dir"
        exit 1
    fi

    # Extract devDependencies
    local dev_deps
    dev_deps=$(jq -r '.devDependencies // {} | to_entries | map("\(.key)@\(.value)") | .[]' "$package_json" 2>/dev/null)

    if [ -z "$dev_deps" ]; then
        print_msg WARNING "No devDependencies found in $package_json"
        exit 0
    fi

    # Count packages
    local count
    count=$(echo "$dev_deps" | wc -l | tr -d ' ')
    print_msg INFO "Installing $count devDependencies in $project_dir"

    # Convert to array
    local packages=()
    while IFS= read -r pkg; do
        packages+=("$pkg")
    done <<< "$dev_deps"

    # Run yarn add --dev
    print_msg INFO "Running: yarn add --dev <packages> ${yarn_args[*]}"
    echo ""

    (cd "$project_dir" && yarn add --dev "${packages[@]}" "${yarn_args[@]}")

    echo ""
    print_msg SUCCESS "devDependencies installed successfully"
}

main "$@"
